import pytest
import responses
from engines.crtsh import parse_results, query_engine
from utils.config import QueryError
from requests.exceptions import HTTPError, RequestException, JSONDecodeError
from models.datatypes import ObservableMap, Report

# TODO: Add additional pytest test for ValidationErrors


@pytest.fixture()
def observable_dict() -> ObservableMap:
    return ObservableMap({"value": "cyberbro.net", "type": "FQDN"})


@pytest.fixture()
def valid_response() -> list[dict]:
    """crt.sh result for cyberbro.net, as of 2025-07-13"""
    return [
        {
            "issuer_ca_id": 204407,
            "issuer_name": "C=GB, O=Sectigo Limited, CN=Sectigo Public Server Authentication CA DV E36",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 19162677153,
            "entry_timestamp": "2025-06-21T20:11:29.877",
            "not_before": "2025-06-21T00:00:00",
            "not_after": "2025-09-13T18:29:44",
            "serial_number": "2ed460d8cb735c760b79d8f3e5ff011a",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 204407,
            "issuer_name": "C=GB, O=Sectigo Limited, CN=Sectigo Public Server Authentication CA DV E36",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 19162677219,
            "entry_timestamp": "2025-06-21T20:11:29.354",
            "not_before": "2025-06-21T00:00:00",
            "not_after": "2025-09-13T18:29:44",
            "serial_number": "2ed460d8cb735c760b79d8f3e5ff011a",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 19038086403,
            "entry_timestamp": "2025-06-15T15:29:59.342",
            "not_before": "2025-06-15T15:19:55",
            "not_after": "2025-09-13T15:26:53",
            "serial_number": "51c1d201559094ba1dc725fe2c8bb4f3",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 19038103921,
            "entry_timestamp": "2025-06-15T15:29:56.951",
            "not_before": "2025-06-15T15:19:55",
            "not_after": "2025-09-13T15:26:53",
            "serial_number": "51c1d201559094ba1dc725fe2c8bb4f3",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282053,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing RSA CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 19038024386,
            "entry_timestamp": "2025-06-15T15:24:22.555",
            "not_before": "2025-06-15T15:14:21",
            "not_after": "2025-09-13T15:19:01",
            "serial_number": "7eb21fa3784d6561bd0bdec0a59b916e",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17911122241,
            "entry_timestamp": "2025-04-17T21:37:08.713",
            "not_before": "2025-04-17T00:00:00",
            "not_after": "2025-07-16T16:30:48",
            "serial_number": "00e5e9074f1c648b2a351496c36c24162b",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17911122135,
            "entry_timestamp": "2025-04-17T21:37:07.387",
            "not_before": "2025-04-17T00:00:00",
            "not_after": "2025-07-16T16:30:48",
            "serial_number": "00e5e9074f1c648b2a351496c36c24162b",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17905420184,
            "entry_timestamp": "2025-04-17T14:34:58.595",
            "not_before": "2025-04-17T14:24:50",
            "not_after": "2025-07-16T14:32:20",
            "serial_number": "46c3e40db0dec4fc3ac0871c74790c5c",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17905410350,
            "entry_timestamp": "2025-04-17T14:34:51.861",
            "not_before": "2025-04-17T14:24:50",
            "not_after": "2025-07-16T14:32:20",
            "serial_number": "46c3e40db0dec4fc3ac0871c74790c5c",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282053,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing RSA CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17905340530,
            "entry_timestamp": "2025-04-17T14:29:18.035",
            "not_before": "2025-04-17T14:19:16",
            "not_after": "2025-07-16T14:27:45",
            "serial_number": "33f30678bc74be9cbd6c5b16c86e8060",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 16799258299,
            "entry_timestamp": "2025-02-17T14:37:54.908",
            "not_before": "2025-02-17T00:00:00",
            "not_after": "2025-05-18T14:27:29",
            "serial_number": "00f3ea3995dd7e8cf1f510090e1ad66163",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 16799258154,
            "entry_timestamp": "2025-02-17T14:37:53.43",
            "not_before": "2025-02-17T00:00:00",
            "not_after": "2025-05-18T14:27:29",
            "serial_number": "00f3ea3995dd7e8cf1f510090e1ad66163",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 17242727998,
            "entry_timestamp": "2025-02-17T13:52:03.225",
            "not_before": "2025-02-17T13:41:52",
            "not_after": "2025-05-18T13:49:11",
            "serial_number": "2360fa2b1f8c2c55ce8707b8853fb52d",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 16758774428,
            "entry_timestamp": "2025-02-17T13:51:53.873",
            "not_before": "2025-02-17T13:41:52",
            "not_after": "2025-05-18T13:49:11",
            "serial_number": "2360fa2b1f8c2c55ce8707b8853fb52d",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282053,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing RSA CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 16758771276,
            "entry_timestamp": "2025-02-17T13:46:43.132",
            "not_before": "2025-02-17T13:36:42",
            "not_after": "2025-05-18T13:45:25",
            "serial_number": "4a410b679ba5e2e7800c3872ac109254",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 295810,
            "issuer_name": "C=US, O=Let's Encrypt, CN=E5",
            "common_name": "demo.cyberbro.net",
            "name_value": "demo.cyberbro.net",
            "id": 16294673668,
            "entry_timestamp": "2024-12-30T13:21:50.908",
            "not_before": "2024-12-30T12:23:20",
            "not_after": "2025-03-30T12:23:19",
            "serial_number": "03a75be2cd2de32886be097734c00aa320eb",
            "result_count": 2,
        },
        {
            "issuer_ca_id": 295810,
            "issuer_name": "C=US, O=Let's Encrypt, CN=E5",
            "common_name": "demo.cyberbro.net",
            "name_value": "demo.cyberbro.net",
            "id": 16079068072,
            "entry_timestamp": "2024-12-30T13:21:50.716",
            "not_before": "2024-12-30T12:23:20",
            "not_after": "2025-03-30T12:23:19",
            "serial_number": "03a75be2cd2de32886be097734c00aa320eb",
            "result_count": 2,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 15831547075,
            "entry_timestamp": "2024-12-20T14:35:26.36",
            "not_before": "2024-12-20T00:00:00",
            "not_after": "2025-03-20T12:57:16",
            "serial_number": "17888a81ffe96b28dc9bb1df85539abe",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 105484,
            "issuer_name": "C=GB, ST=Greater Manchester, L=Salford, O=Sectigo Limited, CN=Sectigo ECC Domain Validation Secure Server CA",
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 15831546980,
            "entry_timestamp": "2024-12-20T14:35:25.24",
            "not_before": "2024-12-20T00:00:00",
            "not_after": "2025-03-20T12:57:16",
            "serial_number": "17888a81ffe96b28dc9bb1df85539abe",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 282054,
            "issuer_name": 'C=US, O="CLOUDFLARE, INC.", CN=Cloudflare TLS Issuing ECC CA 1',
            "common_name": "cyberbro.net",
            "name_value": "*.cyberbro.net\ncyberbro.net",
            "id": 15830089806,
            "entry_timestamp": "2024-12-20T13:00:02.72",
            "not_before": "2024-12-20T12:50:01",
            "not_after": "2025-03-20T12:57:15",
            "serial_number": "5b261941a6ab2f866a01460cfda53999",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 12527578801,
            "entry_timestamp": "2024-03-28T21:23:06.766",
            "not_before": "2024-03-28T20:23:06",
            "not_after": "2024-06-26T20:23:05",
            "serial_number": "03fba62ffc01aa3211c13077052710076789",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 12531758357,
            "entry_timestamp": "2024-03-28T21:23:06.56",
            "not_before": "2024-03-28T20:23:06",
            "not_after": "2024-06-26T20:23:05",
            "serial_number": "03fba62ffc01aa3211c13077052710076789",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 11899004153,
            "entry_timestamp": "2024-01-28T20:44:13.994",
            "not_before": "2024-01-28T19:44:13",
            "not_after": "2024-04-27T19:44:12",
            "serial_number": "0362047614244fc1ed3538334b91493c2caf",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 11898998551,
            "entry_timestamp": "2024-01-28T20:44:13.835",
            "not_before": "2024-01-28T19:44:13",
            "not_after": "2024-04-27T19:44:12",
            "serial_number": "0362047614244fc1ed3538334b91493c2caf",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 11263821668,
            "entry_timestamp": "2023-11-29T21:03:42.196",
            "not_before": "2023-11-29T20:03:41",
            "not_after": "2024-02-27T20:03:40",
            "serial_number": "04cd3f3f330e9aaa8fb8675361477af284c8",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 11263815736,
            "entry_timestamp": "2023-11-29T21:03:41.85",
            "not_before": "2023-11-29T20:03:41",
            "not_after": "2024-02-27T20:03:40",
            "serial_number": "04cd3f3f330e9aaa8fb8675361477af284c8",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 10757856245,
            "entry_timestamp": "2023-09-30T21:11:38.206",
            "not_before": "2023-09-30T20:11:37",
            "not_after": "2023-12-29T20:11:36",
            "serial_number": "032c20e7f800fa328aebf68dba848a85631a",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 10549662371,
            "entry_timestamp": "2023-09-30T21:11:37.586",
            "not_before": "2023-09-30T20:11:37",
            "not_after": "2023-12-29T20:11:36",
            "serial_number": "032c20e7f800fa328aebf68dba848a85631a",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 10149513320,
            "entry_timestamp": "2023-08-01T22:06:04.309",
            "not_before": "2023-08-01T21:06:04",
            "not_after": "2023-10-30T21:06:03",
            "serial_number": "03d4c2501f9d3a4c6865486ed442785f4927",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 10109891235,
            "entry_timestamp": "2023-08-01T22:06:04.176",
            "not_before": "2023-08-01T21:06:04",
            "not_after": "2023-10-30T21:06:03",
            "serial_number": "03d4c2501f9d3a4c6865486ed442785f4927",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 9571485341,
            "entry_timestamp": "2023-06-02T22:05:44.338",
            "not_before": "2023-06-02T21:05:43",
            "not_after": "2023-08-31T21:05:42",
            "serial_number": "04658a445b67972fe055f07488160c8540cd",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "www.cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 9554256698,
            "entry_timestamp": "2023-06-02T22:05:44.073",
            "not_before": "2023-06-02T21:05:43",
            "not_after": "2023-08-31T21:05:42",
            "serial_number": "04658a445b67972fe055f07488160c8540cd",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 9072308604,
            "entry_timestamp": "2023-04-03T22:06:48.463",
            "not_before": "2023-04-03T21:06:48",
            "not_after": "2023-07-02T21:06:47",
            "serial_number": "031d317d8a5691b105553ca39d01fb84b9c1",
            "result_count": 3,
        },
        {
            "issuer_ca_id": 183267,
            "issuer_name": "C=US, O=Let's Encrypt, CN=R3",
            "common_name": "cyberbro.net",
            "name_value": "cyberbro.net\nwww.cyberbro.net",
            "id": 9052339501,
            "entry_timestamp": "2023-04-03T22:06:48.277",
            "not_before": "2023-04-03T21:06:48",
            "not_after": "2023-07-02T21:06:47",
            "serial_number": "031d317d8a5691b105553ca39d01fb84b9c1",
            "result_count": 3,
        },
    ]


@pytest.fixture()
def valid_report() -> Report:
    return Report(
        {
            "top_domains": [
                {"domain": "cyberbro.net", "count": 32},
                {"domain": "*.cyberbro.net", "count": 18},
                {"domain": "www.cyberbro.net", "count": 14},
                {"domain": "demo.cyberbro.net", "count": 2},
            ],
            "link": "https://crt.sh/?q=cyberbro.net",
        }
    )


@responses.activate
def test_query_engine_http_error(valid_response, proxies, ssl_verify):
    responses.add(responses.GET, "https://crt.sh/json?q=cyberbro.net", body=HTTPError())

    with pytest.raises(QueryError):
        _ = query_engine("cyberbro.net", proxies, ssl_verify)


def test_parse_results(observable_dict, valid_response, valid_report):
    target: str = observable_dict.get("value")

    report: Report = parse_results(query_results=valid_response, target=target)

    assert report == valid_report
