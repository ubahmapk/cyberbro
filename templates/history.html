{% extends "base.html" %}

{% block title %}Cyberbro - Analysis History{% endblock title %}

{% block head %}
    {{ super() }}
    <script defer src="{{ url_for('static', filename='history.js') }}"></script>
{% endblock head %}

{% block content %}
{{ super() }}

<!-- Header Section -->
<div style="margin-bottom: 2rem;">
    <div style="margin-bottom: 1rem;">
        <h1 style="margin: 0;">Analysis History</h1>
    </div>

    <!-- Metadata and Search -->
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.875rem; color: var(--text-secondary); align-items: center;">
            <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-weight: 600;">
                {{ analysis_results|length }} Analysis{{ 'es' if analysis_results|length != 1 else '' }}
            </span>
            <span>ğŸ“Š Last 60 analyses</span>
        </div>
    </div>

    <!-- Search Bar -->
    <div style="position: relative; max-width: 600px;">
        <input type="text"
               id="searchInput"
               class="filter-input"
               onkeyup="filterTable()"
               placeholder="ğŸ” Search by ID, observable, or engine..."
               style="width: 100%; padding-left: 1rem;">
    </div>
</div>
<!-- History Table -->
<div class="table-wrapper" style="border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color);">
    <table id="historyTable" style="margin: 0;">
        <thead>
            <tr>
                <th style="width: 180px;">ğŸ“… Date</th>
                <th style="width: 280px;">ğŸ”‘ Analysis ID</th>
                <th>ğŸ¯ Observables</th>
                <th style="width: 100px; text-align: center;">ğŸ“Š Count</th>
                <th style="width: 200px;">âš™ï¸ Engines</th>
            </tr>
        </thead>
        <tbody>
            {% for analysis in analysis_results %}
            <tr style="cursor: pointer;" onclick="window.location.href='/results/{{ analysis.id }}'">
                <td style="font-size: 0.875rem; color: var(--text-secondary);">
                    {{ analysis.end_time_string }}
                </td>
                <td>
                    <a href="/results/{{ analysis.id }}"
                       style="font-family: monospace; font-size: 0.875rem; text-decoration: none; color: var(--primary-color); font-weight: 500;"
                       onclick="event.stopPropagation();">
                        {{ analysis.id }}
                    </a>
                </td>
                <td>
                    <p id="observables-in-analysis"
                       title="{{ analysis.results|map(attribute='observable')|join(', ') }}"
                       style="margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.875rem;">
                        {% set observables = analysis.results|map(attribute='observable')|list %}
                        {% set display_observables = observables[:3] %}
                        {% set display_text = display_observables|join(', ') %}
                        {% if display_text|length > 80 %}
                        {{ display_text[:80] }}...
                        {% else %}
                        {{ display_text }}
                        {% endif %}
                        {% if observables|length > 3 %} <span style="color: var(--text-secondary);">+{{ observables|length - 3 }} more</span>{% endif %}
                    </p>
                </td>
                <td style="text-align: center;">
                    <span style="background: rgba(0, 123, 255, 0.1); color: var(--primary-color); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.875rem;">
                        {{ analysis.results|length }}
                    </span>
                </td>
                <td>
                    <p id="engines-in-analysis"
                       title="{{ analysis.selected_engines|join(', ') }}"
                       style="margin: 0; font-size: 0.875rem; color: var(--text-secondary);">
                        {% for engine in analysis.selected_engines[:2] %}
                        {{ engine }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                        {% if analysis.selected_engines|length > 2 %} <span style="color: var(--text-muted);">+{{ analysis.selected_engines|length - 2 }}</span>{% endif %}
                    </p>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock content %}
