{% extends "base.html" %}

{% block title %}Cyberbro - Observable Analysis{% endblock title %}

{%- set placholder_text -%}
1.2.3.4
example.com
d41d8cd98f00b204e9800998ecf8427e
chrome extension id
Or just IoC (plain text, separated, html, json, csv, log data, garbage data, fanged data [.] [dot] hxxp, etc.)"
{%- endset -%}

{% block content %}
{{ super() }}
<div id="startForm">
    <div class="page-header">
        <h1>Observable Analysis</h1>
        <p>Analyze IPs, domains, URLs, hashes, and other observables</p>
    </div>

    {% if new_version_available %}
    {% include "upgrade_notification.html" %}
    {% endif %}

    <form id="analyzeForm" method="POST" action="/analyze">
        <label for="observables">Paste your observables here</label>
        <textarea name="observables" placeholder="{{ placholder_text }}" required
            style="margin-top: var(--spacing-sm); min-height: 150px; width: 100%; max-width: 100%; box-sizing: border-box;"></textarea>

        <h3 style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm);">Select Analysis Engines</h3>

        <!-- Filter tabs -->
        <div class="filter-tabs">
            <button type="button" class="filter-tab" onclick="selectDefault()">
                üéØ Default
            </button>
            <button type="button" class="filter-tab" onclick="selectAllEngines()">
                ‚ú® All Engines
            </button>
            <button type="button" class="filter-tab" onclick="selectFree()">
                üÜì Free (No API Key)
            </button>
            <button type="button" class="filter-tab" onclick="selectAbuseChecker()">
                üìß Abuse Contact
            </button>
            <button type="button" class="filter-tab" onclick="selectHash()">
                #Ô∏è‚É£ Hash Analysis
            </button>
            <button type="button" class="filter-tab" onclick="selectVpn()">
                üîí VPN/Proxy Detection
            </button>
            <button type="button" class="filter-tab" onclick="selectExtension()">
                üß© Extension Check
            </button>
            <button type="button" class="filter-tab" onclick="selectNone()">
                ‚ùå Clear All
            </button>
        </div>

        <!-- Engines grid -->
        <div id="enginesContainer" class="engines-grid"></div>

        <script>
            const GUI_ENABLED_ENGINES = JSON.parse('{% if GUI_ENABLED_ENGINES | length > 0 %} {{ GUI_ENABLED_ENGINES | tojson }} {% else %} [] {% endif %}');

            const engineIcons = {
                'abuseipdb': '‚ö†Ô∏è',
                'abusix': 'üìß',
                'alienvault': 'üõ°Ô∏è',
                'bad_asn': 'üö´',
                'criminalip': 'üöî',
                'crowdstrike': '‚ö°',
                'crtsh': 'üîê',
                'dfir_iris': 'üìä',
                'github': 'üíª',
                'google': 'G',
                'google_dns': 'üåê',
                'google_safe_browsing': 'üîç',
                'hudsonrock': 'ü™®',
                'ioc_one_html': 'üìÑ',
                'ioc_one_pdf': 'üìë',
                'ipapi': 'üåç',
                'ipinfo': '‚ÑπÔ∏è',
                'ipquery': '‚ùì',
                'mde': 'üõ°Ô∏è',
                'misp': 'üîó',
                'opencti': 'üéØ',
                'phishtank': 'üé£',
                'rdap': 'üìã',
                'reverse_dns': 'üîÑ',
                'rl_analyze': 'üî¨',
                'rosti': 'ü•î',
                'shodan': 'üî≠',
                'spur': 'üé™',
                'threatfox': 'ü¶ä',
                'urlscan': 'üîé',
                'virustotal': 'ü¶†',
                'webscout': 'üåê'
            };

            const allEngines = [
                { name: "abuseipdb", label: "AbuseIPDB", supports: "risk", checked: false, description: "IP reputation & abuse reports", tooltip: "Checks AbuseIPDB for IP, reversed obtained IP for a given domain / URL, free API key required" },
                { name: "abusix", label: "Abusix", supports: "abuse free_no_key", checked: false, description: "Abuse contact lookup (free)", tooltip: "Checks abuse contact with Abusix only for IP, reversed obtained IP for a given domain / URL, free, no API key" },
                { name: "alienvault", label: "Alienvault", supports: "hash ip domain url", checked: false, description: "Threat intelligence platform", tooltip: "Checks Alienvault for IP, domain, URL, hash, free API key required" },
                { name: "bad_asn", label: "Bad ASN Check", supports: "ip risk free_no_key", checked: false, description: "Malicious ASN detection (free)", tooltip: "Checks if IP's ASN is listed in Spamhaus ASNDROP, Brianhama Bad ASN databases, or LETHAL-FORENSICS ASN Blacklist. Requires ipapi, ipinfo, or ipquery engine. Free, no API key" },
                { name: "criminalip", label: "Criminal IP", supports: "ip", checked: false, description: "Attack surface & threat hunting", tooltip: "Criminal IP is an OSINT search engine specialized in attack surface assessment and threat hunting, free, with paid upgrades available" },
                { name: "crowdstrike", label: "CrowdStrike", supports: "hash ip domain url", checked: false, description: "Advanced threat detection", tooltip: "Checks CrowdStrike for IP, domain, URL, hash, paid API key required" },
                { name: "crtsh", label: "crt.sh", supports: "domain url free_no_key", checked: false, description: "Certificate transparency logs", tooltip: "Checks crt.sh for subdomains using the certificate transparency logs given domain / URL, free, no API key" },
                { name: "dfir_iris", label: "DFIR-IRIS", supports: "domain url ip hash extension", checked: false, description: "Incident response platform", tooltip: "Searches DFIR-IRIS results for all types of observable, API key required" },
                { name: "github", label: "Github", supports: "domain url ip hash extension free_no_key scraping", checked: false, description: "Code search via grep.app", tooltip: "Get Github grep.app API search results for all types of observable, free, no API key" },
                { name: "google", label: "Google", supports: "domain url ip hash extension", checked: false, description: "Google Custom Search results", tooltip: "Checks Google Custom Search Engine (CSE) API results for all types of observable, free API required" },
                { name: "google_dns", label: "Google DNS", supports: "domain url ip free_no_key", checked: false, description: "Common DNS records lookup", tooltip: "Checks Google common DNS records (A, AAAA, CNAME, NS, MX, TXT - including SPF and DMARC, PTR) for IP, domain, URL, free, no API key" },
                { name: "google_safe_browsing", label: "Safe Browsing", supports: "risk domain ip", checked: false, description: "Google's threat detection", tooltip: "Checks Google Safe Browsing, free API key required" },
                { name: "ioc_one_html", label: "Ioc.One (HTML)", supports: "domain url ip hash extension scraping", checked: false, description: "HTML threat reports search", tooltip: "Scraps (can be long) Ioc.One HTML search results for all types of observable, free, no API key" },
                { name: "ioc_one_pdf", label: "Ioc.One (PDF)", supports: "domain url ip hash extension scraping", checked: false, description: "PDF threat reports search", tooltip: "Scraps (can be long) Ioc.One PDF search results for all types of observable, free, no API key" },
                { name: "hudsonrock", label: "Hudson Rock", supports: "domain url email free_no_key", checked: false, description: "Infostealer leak database", tooltip: "Searches Hudson Rock leak / infostealer results for domains, URL, Email, free, no API key" },
                { name: "ipapi", label: "IPapi", supports: "default ip vpn proxy risk free_no_key", checked: true, description: "IP geolocation & proxy detection", tooltip: "Checks IPapi for IP, reversed obtained IP for a given domain / URL, free, no API key" },
                { name: "ipinfo", label: "IPinfo", supports: "ip", checked: false, description: "IP address information", tooltip: "Checks IPinfo for IP, reversed obtained IP for a given domain / URL, free API key required" },
                { name: "ipquery", label: "IPquery", supports: "ip risk vpn proxy free_no_key", checked: false, description: "IP intelligence (default, free)", tooltip: "Checks IPquery for IP, reversed obtained IP for a given domain / URL, free, no API key" },
                { name: "mde", label: "Microsoft Defender", supports: "hash ip domain url", checked: false, description: "Enterprise endpoint security", tooltip: "Checks Microsoft Defender for Endpoint, paid API info on Azure required" },
                { name: "misp", label: "MISP", supports: "domain url ip hash extension", checked: false, description: "Threat sharing platform", tooltip: "Searches MISP for all types of observable, API key required" },
                { name: "opencti", label: "OpenCTI", supports: "domain url ip hash extension", checked: false, description: "Cyber threat intelligence", tooltip: "Searches OpenCTI results for all types of observable, API key required" },
                { name: "phishtank", label: "Phishtank", supports: "risk domain url free_no_key", checked: false, description: "Phishing site verification", tooltip: "Checks Phishtank for domains, URL, free, no API key" },
                { name: "reverse_dns", label: "Reverse DNS", supports: "default domain ip abuse free_no_key", checked: true, description: "DNS lookup (default, free)", tooltip: "Performs a reverse DNS lookup for IP, domain, URL (on your machine)" },
                { name: "rdap", label: "RDAP", supports: "default abuse domain free_no_key", checked: true, description: "Domain registration data", tooltip: "Checks RDAP (ex Whois) record for domain, URL, no API key required" },
                { name: "rl_analyze", label: "ReversingLabs", supports: "domain url ip hash extension", checked: false, description: "File & threat analysis", tooltip: "Searches Reversing Labs Spectra Analyze results for all types of observable, API key required" },
                { name: "rosti", label: "R√∂sti", supports: "domain url ip email hash", checked: false, description: "IOC search and enrichment", tooltip: "Searches R√∂sti IOC data for domains, URLs, IPs, emails, and hashes (MD5, SHA1, SHA256), API key required" },
                { name: "shodan", label: "Shodan", supports: "ports ip", checked: false, description: "Internet-connected device search", tooltip: "Checks Shodan, reversed obtained IP for a given domain / URL, free API key required" },
                { name: "spur", label: "Spur.us", supports: "vpn proxy ip", checked: false, description: "Anonymous proxy detection", tooltip: "Checks Spur.us for IP, reversed obtained IP for a given domain / URL, paid API key required" },
                { name: "threatfox", label: "ThreatFox", supports: "ip domain url", checked: false, description: "Malware IOC database", tooltip: "Checks ThreatFox by Abuse.ch for IP, domains, URL, free API key required" },
                { name: "urlscan", label: "URLscan", supports: "domain url ip hash free_no_key", checked: false, description: "Website scanner & analyzer", tooltip: "Checks URLscan for IP, domains, URL, hash, free, no API key" },
                { name: "virustotal", label: "VirusTotal", supports: "hash risk ip domain url", checked: false, description: "Multi-engine malware scanner", tooltip: "Checks VirusTotal for IP, domain, URL, hash, free API key required" },
                { name: "webscout", label: "WebScout", supports: "ip vpn proxy risk", checked: false, description: "IP reputation & risk scoring", tooltip: "Checks WebScout for IP, reversed obtained IP for a given domain / URL, free or paid API key required" },
            ];

            const enginesToDisplay = GUI_ENABLED_ENGINES.length > 0
                ? allEngines.filter(engine => GUI_ENABLED_ENGINES.includes(engine.name))
                : allEngines;

            function renderEngines() {
                const container = document.getElementById('enginesContainer');
                container.innerHTML = '';

                enginesToDisplay.forEach(engine => {
                    const card = document.createElement('label');
                    card.className = 'engine-card';
                    card.dataset.supports = engine.supports;
                    card.title = engine.tooltip; // Add hover tooltip with full description

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'engines';
                    checkbox.value = engine.name;
                    checkbox.checked = engine.checked;

                    checkbox.addEventListener('change', function () {
                        updateCardState(card, this.checked);
                    });

                    const icon = document.createElement('div');
                    icon.className = 'engine-icon';
                    icon.textContent = engineIcons[engine.name] || 'üîß';

                    const info = document.createElement('div');
                    info.className = 'engine-info';

                    const title = document.createElement('h4');
                    title.textContent = engine.label;

                    const desc = document.createElement('p');
                    desc.textContent = engine.description;

                    info.appendChild(title);
                    info.appendChild(desc);

                    card.appendChild(checkbox);
                    card.appendChild(icon);
                    card.appendChild(info);

                    updateCardState(card, checkbox.checked);
                    container.appendChild(card);
                });
            }

            function updateCardState(card, isChecked) {
                if (isChecked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            }

            function selectAllEngines() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    checkbox.checked = true;
                    updateCardState(checkbox.closest('.engine-card'), true);
                });
                updateFilterTabs('all');
            }

            function selectNone() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    checkbox.checked = false;
                    updateCardState(checkbox.closest('.engine-card'), false);
                });
                updateFilterTabs('none');
            }

            function selectAbuseChecker() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('abuse');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('abuse');
            }

            function selectHash() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('hash');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('hash');
            }

            function selectVpn() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('vpn');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('vpn');
            }

            function selectDefault() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('default');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('default');
            }

            function selectFree() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('free_no_key');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('free');
            }

            function selectExtension() {
                document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                    const supports = checkbox.closest('.engine-card').dataset.supports;
                    checkbox.checked = supports.includes('extension');
                    updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                });
                updateFilterTabs('extension');
            }

            function updateFilterTabs(activeFilter) {
                document.querySelectorAll('.filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }

            function saveSelection() {
                const selectedEngines = Array.from(document.querySelectorAll('input[name="engines"]:checked')).map(checkbox => checkbox.value);
                localStorage.setItem('selectedEngines', JSON.stringify(selectedEngines));

                // Visual feedback
                const saveBtn = document.getElementById('saveSelectionBtn');
                const originalHTML = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span>‚úÖ</span><span>Saved!</span>';
                saveBtn.disabled = true;

                setTimeout(() => {
                    saveBtn.innerHTML = originalHTML;
                    saveBtn.disabled = false;
                }, 1500);
            }

            function restoreSelection() {
                const savedEngines = JSON.parse(localStorage.getItem('selectedEngines'));
                if (savedEngines) {
                    document.querySelectorAll('input[name="engines"]').forEach(checkbox => {
                        checkbox.checked = savedEngines.includes(checkbox.value);
                        updateCardState(checkbox.closest('.engine-card'), checkbox.checked);
                    });
                }
            }

            // ========================================
            // Engine Validation
            // ========================================

            /**
             * Configuration for engine dependencies.
             * Add new dependency checks here as needed.
             */
            const ENGINE_DEPENDENCIES = {
                bad_asn: {
                    providers: ['ipapi', 'ipinfo', 'ipquery', 'webscout'],
                    defaultProvider: 'ipapi',
                    message: {
                        title: '‚ö†Ô∏è ASN Provider Required',
                        body: 'You selected <strong>Bad ASN Check</strong> but no ASN provider is selected. Bad ASN requires an ASN provider to work properly.',
                        providers: 'Please select one of: <strong>IPapi</strong>, <strong>IPinfo</strong>, <strong>IPquery</strong>, or <strong>WebScout</strong>.'
                    }
                }
            };

            /**
             * Get list of currently selected engines.
             * @returns {string[]} Array of selected engine names
             */
            function getSelectedEngines() {
                return Array.from(document.querySelectorAll('input[name="engines"]:checked'))
                    .map(checkbox => checkbox.value);
            }

            /**
             * Check if an engine requires a provider that is not selected.
             * @param {string} engineName - Name of the engine to check
             * @param {string[]} selectedEngines - List of currently selected engines
             * @returns {boolean} True if dependency is missing
             */
            function isMissingDependency(engineName, selectedEngines) {
                const dependency = ENGINE_DEPENDENCIES[engineName];
                if (!dependency) return false;

                const hasEngine = selectedEngines.includes(engineName);
                const hasProvider = dependency.providers.some(provider =>
                    selectedEngines.includes(provider)
                );

                return hasEngine && !hasProvider;
            }

            /**
             * Create a confirmation dialog overlay.
             * @param {Object} config - Dialog configuration
             * @returns {HTMLElement} The overlay element
             */
            function createConfirmationDialog(config) {
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; ' +
                    'background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';

                const dialog = document.createElement('div');
                dialog.style.cssText = 'background: var(--bg-color, white); padding: 30px; ' +
                    'border-radius: 8px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';

                dialog.innerHTML = `
                    <h3 style="margin-top: 0; color: var(--text-color, #333);">${config.title}</h3>
                    <p style="color: var(--text-color, #666); line-height: 1.6;">${config.body}</p>
                    <p style="color: var(--text-color, #666); line-height: 1.6;">${config.providers}</p>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="confirmBtn" class="btn btn-icon" style="flex: 1;">
                            <span>‚úÖ</span>
                            <span>${config.confirmText}</span>
                        </button>
                        <button id="cancelBtn" class="btn btn-outline" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                `;

                overlay.appendChild(dialog);
                return overlay;
            }

            /**
             * Enable an engine and update its visual state.
             * @param {string} engineName - Name of the engine to enable
             */
            function enableEngine(engineName) {
                const checkbox = document.querySelector(`input[name="engines"][value="${engineName}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                    const card = checkbox.closest('.engine-card');
                    if (card) {
                        updateCardState(card, true);
                    }
                }
            }

            /**
             * Show dependency warning dialog and handle user response.
             * @param {string} engineName - Name of the engine with missing dependency
             * @param {Function} onConfirm - Callback when user confirms
             */
            function showDependencyWarning(engineName, onConfirm) {
                const dependency = ENGINE_DEPENDENCIES[engineName];
                const config = {
                    ...dependency.message,
                    confirmText: `Add ${dependency.defaultProvider.toUpperCase()} & Continue`
                };

                const overlay = createConfirmationDialog(config);
                document.body.appendChild(overlay);

                // Handle confirm
                document.getElementById('confirmBtn').onclick = function () {
                    enableEngine(dependency.defaultProvider);
                    document.body.removeChild(overlay);
                    onConfirm();
                };

                // Handle cancel
                document.getElementById('cancelBtn').onclick = function () {
                    document.body.removeChild(overlay);
                };

                // Close on overlay click
                overlay.onclick = function (e) {
                    if (e.target === overlay) {
                        document.body.removeChild(overlay);
                    }
                };
            }

            /**
             * Validate form submission for engine dependencies.
             * @param {Event} event - Form submit event
             * @returns {boolean} True if validation passed
             */
            function validateEngineSelection(event) {
                const selectedEngines = getSelectedEngines();

                // Check each engine for missing dependencies
                for (const engineName in ENGINE_DEPENDENCIES) {
                    if (isMissingDependency(engineName, selectedEngines)) {
                        event.preventDefault();
                        showDependencyWarning(engineName, function () {
                            document.getElementById('analyzeForm').submit();
                        });
                        return false;
                    }
                }

                return true;
            }

            // Attach validation to form
            document.getElementById('analyzeForm').addEventListener('submit', validateEngineSelection);

            // Initialize
            renderEngines();
            document.addEventListener('DOMContentLoaded', restoreSelection);
        </script>

        <div class="button-group" style="margin-top: var(--spacing-md);">
            <button type="submit" class="btn btn-icon">
                <span>üîç</span>
                <span>Start Analysis</span>
            </button>
            <button type="button" id="saveSelectionBtn" class="btn btn-outline btn-icon" onclick="saveSelection()">
                <span>üíæ</span>
                <span>Save Selection</span>
            </button>
        </div>
    </form>
</div>
{% endblock content %}